name: Node ja App

on:
    push:
        branches: [ main ]
    pull_request: 
        branches: [ main ]


jobs:

    prepare: 
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repo
          uses: actions/checkout@v4

        - name: Extract Version
          run : |
            VERSION=$(jq -r .version package.json)
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "version: \"$VERSION\"" > version.yaml
            ls -l

        - name:  Debuugung the extracted Version
          run: echo $VERSION

        - name: Upload Version artifact
          uses: actions/upload-artifact@v4
          with:
            name: version
            path: version.yaml

        
    docker:
        needs: prepare
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Download artifact
              uses: actions/download-artifact@v4
              with:
                name: version

            - name: Load version into enviroment
              run: |
               VESRION=$(grep 'version' version.yaml | awk -F': ' '{print $2}')
               echo "VERSION=$VERSION" >> $GITHUB_ENV

            - name: Login to DockerHub
              uses: docker/login-action@v3
              with: 
                username: ${{ secrets.DOCKER_UNAME }}
                password: ${{ secrets.DOCKER_PAT }}

            - name: Build and push Image 
              uses: docker/build-push-action@v6 
              with:
                context: .
                file: ./Dockerfile
                push: true
                tags: ayat93/nodeapp:555
    deploy:
      runs-on: ubuntu-latest
      needs: docker
      steps:
        - name: ssh to the server
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.HOST }}
            username: ${{ secrets.HOST_NAME }}
            key: ${{ secrets.KEY }}
            script: |
              echo "pull 555 image"
              docker pull ${{ secrets.DOCKER_UNAME }}/nodeapp:{{ENV.VERSION}}

              docker stop nodeapp 
              docker rm nodeapp
              docker run -dp 81:3000 --name nodeapp ${{ secrets.DOCKER_UNAME }}/nodeapp:555